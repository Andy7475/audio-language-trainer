<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="../../../../styles/styles.css">
</head>

<body>
    <nav class="breadcrumb">
        <a href="../../index.html">Stories</a> â€º
        <a href="../index.html">{{ target_language_name }}</a> â€º
        <span>{{ title }}</span>
    </nav>

    <header>
        <h1>{{ title }}</h1>
        <p class="summary">{{ summary }}</p>
        <button onclick="playAllParts()" class="play-all">â–¶ Play Entire Story</button>
        <button onclick="toggleAllSource()" id="globalSourceToggle" class="toggle-source">
            ğŸ‘ï¸ Hide All {{ source_language_name }}
        </button>
        <a href="full_story.mp3" download="{{ title_snake_case }}.mp3" class="download-btn">
            â¬‡ï¸ Download Full Story
        </a>
    </header>

    <nav class="story-nav">
    {% for story_part, utterances in story_parts.items() %}
    <a href="#{{ story_part }}">{{ utterances[0].story_part_titlecase }}</a>
    {% endfor %}
</nav>

    <main>
        {% for story_part, utterances in story_parts.items() %}
        <section id="{{ story_part }}" class="story-part">
            <h2>{{ utterances[0].story_part_titlecase }}</h2>
            <button onclick="playPart('{{ story_part }}')" class="play-part">â–¶ Play {{ utterances[0].story_part_titlecase }}</button>

            {% for utterance in utterances %}
            <article class="dialogue">
                <div class="dialogue-speaker">{{ utterance.speaker }}</div>
                <div class="dialogue-target">
                    {{ utterance.wiktionary_links }}
                </div>
                <div class="dialogue-source" onclick="toggleSource(this)" title="Click to reveal/hide translation">{{ utterance.source_text}}</div>
                <div class="dialogue-controls">
                    <button onclick="playAudio('{{ utterance.target_audio_filename_normal }}')" title="Play audio">ğŸ”Š</button>
                    <button onclick='copyText({{ utterance.target_text|tojson }})'
                        title="Copy phrase">ğŸ“‹</button>
                    <button onclick='copyPrompt({{ utterance.target_text|tojson }})'
                        title="Get help understanding">ğŸ’¡</button>
                </div>
            </article>
            {% endfor %}
            
           
            <div class="part-navigation">
                <a href="#top" class="back-to-top-inline">â†‘ Back to Top</a>
            </div>
        </section>
        {% endfor %}

    </main>

    <footer>
        <p><a href="../">â† Back to Stories</a></p>
    </footer>

    <script>
        let currentAudio = null;

        function playAudio(filename) {
            if (currentAudio) {
                currentAudio.pause();
            }
            currentAudio = new Audio(filename);
            currentAudio.play();
        }

        function playPart(partName) {
            playAudio(`${partName}.mp3`);
        }

        function playAllParts() {
            playAudio('full_story.mp3');
        }

        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Phrase copied to clipboard!');
            });
        }

        function copyPrompt(phrase) {
            const prompt = `Can you help me understand this {{ target_language_name }} phrase and how to use it? Respond to me in my native language of {{ source_language_name }} \n\nPhrase: "${phrase}"`;
            navigator.clipboard.writeText(prompt).then(() => {
                alert('Prompt copied! You can now paste this into Claude or another AI assistant.');
            });
        }

       // Global state for Source Language visibility
let allSourceHidden = false;

// Toggle all Source translations
function toggleAllSource() {
    const button = document.getElementById('globalSourceToggle');
    const allSource = document.querySelectorAll('.dialogue-source');
    
    allSourceHidden = !allSourceHidden;
    
    allSource.forEach(element => {
        if (allSourceHidden) {
            element.classList.add('hidden');
        } else {
            element.classList.remove('hidden');
        }
    });
    
    // Update button text
    button.textContent = allSourceHidden ? 'ğŸ‘ï¸ Show All {{ source_language_name }}' : 'ğŸ‘ï¸ Hide All {{ source_language_name }}';
}

// Toggle individual Source translation
function toggleSource(element) {
    // Toggle just this one translation
    element.classList.toggle('hidden');
}
    </script>
</body>

</html>